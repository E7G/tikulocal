name: Build and Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  prepare:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    outputs:
      next_release_tag: ${{ steps.generate_release_tag.outputs.next_release_tag }}
    steps:
      - name: Generate release tag
        id: generate_release_tag
        uses: amitsingh-007/next-release-tag@v6.0.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          tag_prefix: "v"
          tag_template: "yyyy.mm.dd.i"

  build-and-release:
    needs: prepare
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: "ubuntu-latest"
            goos: "linux"
            goarch: "amd64"
            binary_name: "tikulocal-linux-amd64"
            package_ext: "tar.gz"
          - platform: "ubuntu-latest"
            goos: "linux"
            goarch: "arm64"
            binary_name: "tikulocal-linux-arm64"
            package_ext: "tar.gz"
          - platform: "windows-latest"
            goos: "windows"
            goarch: "amd64"
            binary_name: "tikulocal-windows-amd64"
            package_ext: "exe"
          - platform: "macos-latest"
            goos: "darwin"
            goarch: "amd64"
            binary_name: "tikulocal-darwin-amd64"
            package_ext: "app.zip"
          - platform: "macos-latest"
            goos: "darwin"
            goarch: "arm64"
            binary_name: "tikulocal-darwin-arm64"
            package_ext: "app.zip"

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install system dependencies (Linux)
        if: matrix.goos == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y golang gcc libgl1-mesa-dev xorg-dev libxkbcommon-dev

      - name: Install system dependencies (Windows)
        if: matrix.goos == 'windows'
        run: |
          # Install MinGW-w64 for Windows builds
          choco install mingw -y
          # Add MinGW to PATH
          echo "C:\ProgramData\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Install system dependencies (macOS)
        if: matrix.goos == 'darwin'
        run: |
          # Install Xcode command line tools if not present
          xcode-select --install || true
          # Ensure pkg-config is available
          brew install pkg-config || true

      - name: Install Fyne tools
        run: |
          go install github.com/fyne-io/fyne-cross@latest

      - name: Install dependencies
        run: |
          go mod download
          go mod tidy

      - name: Build with Fyne-cross (Windows)
        if: matrix.goos == 'windows'
        shell: cmd
        run: |
          echo "Building with Fyne-cross for Windows..."
          fyne-cross windows -arch ${{ matrix.goarch }} -app-id com.tikulocal.app -icon icon.png
          
          # Check if the exe was created and copy it
          if exist "fyne-cross\bin\tikulocal.exe" (
            echo "Found tikulocal.exe in fyne-cross output, copying to ${{ matrix.binary_name }}${{ matrix.package_ext }}"
            copy "fyne-cross\bin\tikulocal.exe" "${{ matrix.binary_name }}${{ matrix.package_ext }}"
            dir "${{ matrix.binary_name }}${{ matrix.package_ext }}"
          ) else (
            echo "ERROR: tikulocal.exe not found after Fyne-cross build"
            dir fyne-cross\bin 2>nul || echo "fyne-cross\bin directory not found"
            exit /b 1
          )

      - name: Build with Fyne-cross (Linux)
        if: matrix.goos == 'linux'
        run: |
          echo "Building with Fyne-cross for Linux..."
          fyne-cross linux -arch ${{ matrix.goarch }} -app-id com.tikulocal.app -icon icon.png
          
          # Check if the binary was created successfully
          if [ -f "fyne-cross/bin/tikulocal" ]; then
            echo "Found tikulocal binary in fyne-cross output"
            ls -la fyne-cross/bin/tikulocal
          else
            echo "ERROR: tikulocal binary not found after Fyne-cross build"
            ls -la fyne-cross/bin 2>/dev/null || echo "fyne-cross/bin directory not found"
            exit 1
          fi
          
          # Create a directory structure for the Linux app
          mkdir -p tikulocal-linux
          
          # Copy the binary from fyne-cross output
          cp fyne-cross/bin/tikulocal tikulocal-linux/
          echo "Copied binary to tikulocal-linux/"
          
          # Copy icon if it exists
          cp icon.png tikulocal-linux/ 2>/dev/null || echo "Icon not found, continuing without it"
          
          # Create tar.gz package
          tar -czf "${{ matrix.binary_name }}.tar.gz" tikulocal-linux/
          
          # List files to debug
          ls -la
          echo "Created files:"
          ls -la *.tar.gz 2>/dev/null || echo "No tar.gz files found"

      - name: Build with Fyne-cross (macOS)
        if: matrix.goos == 'darwin'
        run: |
          echo "Building with Fyne-cross for macOS..."
          fyne-cross darwin -arch ${{ matrix.goarch }} -app-id com.tikulocal.app -icon icon.png
          
          # Check if the binary was created successfully
          if [ -f "fyne-cross/bin/tikulocal" ]; then
            echo "Found tikulocal binary in fyne-cross output"
            ls -la fyne-cross/bin/tikulocal
          else
            echo "ERROR: tikulocal binary not found after Fyne-cross build"
            ls -la fyne-cross/bin 2>/dev/null || echo "fyne-cross/bin directory not found"
            exit 1
          fi
          
          # Create zip package for macOS
          if [ -d "fyne-cross/bin/tikulocal.app" ]; then
            zip -r "${{ matrix.binary_name }}.app.zip" fyne-cross/bin/tikulocal.app/
            echo "Created app zip from Fyne-cross package"
          else
            # If Fyne packaging failed, create a simple zip with the binary
            echo "Fyne-cross app not found, creating manual package"
            mkdir -p tikulocal-macos
            
            # Copy the binary from fyne-cross output
            cp fyne-cross/bin/tikulocal tikulocal-macos/
            echo "Copied binary to tikulocal-macos/"
            
            # Copy icon if it exists
            cp icon.png tikulocal-macos/ 2>/dev/null || echo "Icon not found, continuing without it"
            
            zip -r "${{ matrix.binary_name }}.app.zip" tikulocal-macos/
            echo "Created manual app zip"
          fi
          
          # List files to debug
          ls -la
          echo "Created files:"
          ls -la *.zip 2>/dev/null || echo "No zip files found"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ matrix.goos }}-${{ matrix.goarch }}
          path: |
            ${{ matrix.binary_name }}.*
          retention-days: 7

      - name: Create Release and Upload Binary
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.prepare.outputs.next_release_tag }}
          name: Release ${{ needs.prepare.outputs.next_release_tag }}
          body: |
            ## ğŸ‰ TikuLocal ${{ needs.prepare.outputs.next_release_tag }}
            
            é¢˜åº“ç®¡ç†ç³»ç»Ÿçš„æœ€æ–°ç‰ˆæœ¬å‘å¸ƒï¼
            
            ### ğŸ“¦ ä¸‹è½½è¯´æ˜
            è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„ç‰ˆæœ¬ä¸‹è½½ï¼š
            
            - **Windows**: `${{ matrix.binary_name }}.exe` (å¸¦å›¾æ ‡çš„å¯æ‰§è¡Œæ–‡ä»¶)
            - **Linux**: `${{ matrix.binary_name }}.tar.gz` (åŒ…å«å›¾æ ‡çš„åº”ç”¨ç¨‹åºåŒ…)
            - **macOS**: `${{ matrix.binary_name }}.app.zip` (å¸¦å›¾æ ‡çš„åº”ç”¨åŒ…)
            
            ### ğŸš€ å¿«é€Ÿå¼€å§‹
            1. ä¸‹è½½å¯¹åº”å¹³å°çš„åº”ç”¨ç¨‹åºåŒ…
            2. **Windows**: ç›´æ¥è¿è¡Œ `.exe` æ–‡ä»¶
            3. **Linux**: è§£å‹ `tar.gz` æ–‡ä»¶å¹¶è¿è¡Œå…¶ä¸­çš„åº”ç”¨ç¨‹åº
            4. **macOS**: è§£å‹ `.app.zip` å¹¶å°†åº”ç”¨æ‹–åˆ° Applications æ–‡ä»¶å¤¹
            5. è®¿é—® Web ç•Œé¢ï¼š`http://localhost:8080`
            6. æ‹–æ”¾ DOCX æ–‡ä»¶å¼€å§‹å¯¼å…¥é¢˜ç›®
            
            ### ğŸ“‹ åŠŸèƒ½ç‰¹æ€§
            - âœ… DOCX æ–‡æ¡£è§£æ
            - âœ… é¢˜ç›®æœç´¢å’Œç®¡ç†
            - âœ… Web API æ¥å£
            - âœ… å›¾å½¢ç•Œé¢ (GUI)
            - âœ… å¤šå¹³å°æ”¯æŒ
            - âœ… åŸç”Ÿåº”ç”¨å›¾æ ‡
            
            ### ğŸ“ ä½¿ç”¨è¯´æ˜
            è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·å‚è€ƒ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
            
            ### ğŸ› é—®é¢˜åé¦ˆ
            å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/${{ github.repository }}/issues) é¡µé¢æäº¤åé¦ˆã€‚
          draft: false
          prerelease: false
          files: |
            ${{ matrix.binary_name }}.*

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install system dependencies (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y golang gcc libgl1-mesa-dev xorg-dev libxkbcommon-dev

      - name: Install Fyne tools
        run: |
          go install fyne.io/tools/cmd/fyne@latest

      - name: Install dependencies
        run: |
          go mod download
          go mod tidy

      - name: Run tests
        run: |
          # Copy test files to main directory to run tests
          cp test/verify_fix.go verify_fix_temp.go
          go run verify_fix_temp.go parser.go models.go
          rm verify_fix_temp.go
          
          cp test/test_parser.go test_parser_temp.go
          go run test_parser_temp.go parser.go models.go
          rm test_parser_temp.go

      # - name: Build test
      #   run: |
      #     # Test that the project builds successfully
      #     go build -v .
          
      #     # Test cross-compilation
      #     GOOS=windows GOARCH=amd64 go build -v .
      #     GOOS=darwin GOARCH=amd64 go build -v .
      #     GOOS=linux GOARCH=amd64 go build -v .

      - name: Test Fyne-cross
        run: |
          # Test Fyne-cross installation
          fyne-cross version