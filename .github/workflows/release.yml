name: Build and Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  prepare:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    outputs:
      next_release_tag: ${{ steps.generate_release_tag.outputs.next_release_tag }}
    steps:
      - name: Generate release tag
        id: generate_release_tag
        uses: amitsingh-007/next-release-tag@v6.0.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          tag_prefix: "v"
          tag_template: "yyyy.mm.dd.i"

  build-and-release:
    needs: prepare
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux - use wildcard to build all supported architectures
          - platform: "ubuntu-latest"
            goos: "linux"
            goarch: "amd64"
            binary_name: "tikulocal-linux"
            package_ext: "tar.gz"
          
          # Windows - use wildcard to build all supported architectures
          - platform: "windows-latest"
            goos: "windows"
            goarch: "amd64"
            binary_name: "tikulocal-windows"
            package_ext: "exe"
          
          # macOS - use wildcard to build all supported architectures
          - platform: "macos-latest"
            goos: "darwin"
            goarch: "arm64"
            binary_name: "tikulocal-darwin"
            package_ext: "app.zip"

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install system dependencies (Linux)
        if: matrix.goos == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y golang gcc libgl1-mesa-dev xorg-dev libxkbcommon-dev

      - name: Install system dependencies (Windows)
        if: matrix.goos == 'windows'
        run: |
          # Install MinGW-w64 for Windows builds
          choco install mingw -y
          # Add MinGW to PATH
          echo "C:\ProgramData\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          
      # - name: Install Docker (Windows)
      #   if: matrix.goos == 'windows'
      #   run: |
      #     # Install Docker Desktop using Chocolatey
      #     choco install docker-desktop -y

      - name: Install system dependencies (macOS)
        if: matrix.goos == 'darwin'
        run: |
          # Install Xcode command line tools if not present
          xcode-select --install || true
          # Ensure pkg-config is available
          brew install pkg-config || true
          
      # - name: Install Docker (macOS)
      #   if: matrix.goos == 'darwin'
      #   run: |
      #     # Install Docker Desktop using Homebrew
      #     brew install --cask docker

      - name: Install Fyne tools
        run: |
          go install fyne.io/tools/cmd/fyne@latest
          go install github.com/fyne-io/fyne-cross@latest

      - name: Install dependencies
        run: |
          go mod download
          go mod tidy

      - name: Build with Fyne package (Windows)
        if: matrix.goos == 'windows'
        shell: cmd
        run: |
          echo "Building with Fyne package for Windows..."
          fyne package -os windows -icon icon.png
          
          # Check if the executable was created
          if exist "tikulocal.exe" (
            echo "Found fyne package executable: tikulocal.exe"
            copy "tikulocal.exe" "tikulocal-windows.exe"
            dir "tikulocal-windows.exe"
          ) else (
            echo "ERROR: Windows executable not found!"
          )

      - name: Build with Fyne-cross (Linux)
        if: matrix.goos == 'linux'
        run: |
          echo "Building with Fyne-cross for Linux all architectures..."
          fyne-cross linux -arch=* -app-id com.tikulocal.app -icon icon.png
          
          # Check the fyne-cross output directory structure
          echo "Checking fyne-cross output directories:"
          ls -la fyne-cross/ 2>/dev/null || echo "fyne-cross directory not found"
          ls -la fyne-cross/dist/ 2>/dev/null || echo "fyne-cross/dist directory not found"
          
          # List all architecture directories
          echo "Available architecture directories:"
          ls -la fyne-cross/dist/linux-* 2>/dev/null || echo "No Linux architecture directories found"
          
          # Process each architecture
          for ARCH_DIR in fyne-cross/dist/linux-*; do
            if [ -d "$ARCH_DIR" ]; then
              # Extract architecture name from directory path
              ARCH=$(basename "$ARCH_DIR" | cut -d'-' -f2)
              echo "Processing architecture: $ARCH (directory: $ARCH_DIR)"
              
              # Look for the output package in fyne-cross/dist directory
              if [ -f "$ARCH_DIR/tikulocal.tar.xz" ]; then
                echo "Found fyne-cross package: $ARCH_DIR/tikulocal.tar.xz"
                
                # Extract the package to get the binary
                echo "Extracting package..."
                cd "$ARCH_DIR"
                tar -xf tikulocal.tar.xz
                cd -
                
                # Look for the binary in extracted contents
                if [ -f "$ARCH_DIR/tikulocal" ]; then
                  echo "Found binary in extracted package"
                  ls -la "$ARCH_DIR/tikulocal"
                  
                  # Create a directory structure for the Linux app
                  mkdir -p "tikulocal-linux-$ARCH"
                  
                  # Copy the binary
                  cp "$ARCH_DIR/tikulocal" "tikulocal-linux-$ARCH/"
                  echo "Copied binary to tikulocal-linux-$ARCH/"
                  
                  # Copy icon if it exists
                  cp icon.png "tikulocal-linux-$ARCH/" 2>/dev/null || echo "Icon not found, continuing without it"
                  
                  # Create final tar.gz package
                  tar -czf "tikulocal-linux-$ARCH.tar.gz" "tikulocal-linux-$ARCH/"
                  echo "Created final package: tikulocal-linux-$ARCH.tar.gz"
                  
                else
                  echo "Binary not found in extracted package, listing contents:"
                  ls -la "$ARCH_DIR/"
                  echo "Using the fyne-cross package as-is"
                  cp "$ARCH_DIR/tikulocal.tar.xz" "tikulocal-linux-$ARCH.tar.xz"
                  echo "Copied fyne-cross package as tikulocal-linux-$ARCH.tar.xz"
                fi
                
              else
                echo "WARNING: fyne-cross package not found in $ARCH_DIR"
              fi
            fi
          done
          
          # List final files
          ls -la
          echo "Created files:"
          ls -la *.tar.* 2>/dev/null || echo "No tar files found"

      - name: Build with Fyne package (macOS)
        if: matrix.goos == 'darwin'
        run: |
          echo "Building with Fyne package for macOS..."
          fyne package -os darwin -icon icon.png
          
          # Check if the app package was created
          if [ -d "tikulocal.app" ]; then
            echo "Found fyne package app: tikulocal.app"
            zip -r "tikulocal-darwin.app.zip" "tikulocal.app/"
            echo "Created app zip: tikulocal-darwin.app.zip"
          else
            echo "ERROR: macOS app package not found!"
          fi



      - name: Create Release and Upload Binary
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.prepare.outputs.next_release_tag }}
          name: Release ${{ needs.prepare.outputs.next_release_tag }}
          body: |
            ## ğŸ‰ TikuLocal ${{ needs.prepare.outputs.next_release_tag }}
            
            é¢˜åº“ç®¡ç†ç³»ç»Ÿçš„æœ€æ–°ç‰ˆæœ¬å‘å¸ƒï¼
            
            ### ğŸ“¦ ä¸‹è½½è¯´æ˜
            è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿå’Œæ¶æ„é€‰æ‹©å¯¹åº”çš„ç‰ˆæœ¬ä¸‹è½½ï¼š
            
            **æ”¯æŒçš„æ¶æ„ï¼š**
            - **Windows**: amd64, 386, arm64
            - **Linux**: amd64, 386, arm, arm64  
            - **macOS**: amd64 (Intel), arm64 (Apple Silicon)
            
            **æ–‡ä»¶æ ¼å¼ï¼š**
            - **Windows**: `.exe` (å¸¦å›¾æ ‡çš„å¯æ‰§è¡Œæ–‡ä»¶)
            - **Linux**: `.tar.gz` æˆ– `.tar.xz` (åŒ…å«å›¾æ ‡çš„åº”ç”¨ç¨‹åºåŒ…)
            - **macOS**: `.app.zip` (å¸¦å›¾æ ‡çš„åº”ç”¨åŒ…)
            
            ### ğŸš€ å¿«é€Ÿå¼€å§‹
            1. ä¸‹è½½å¯¹åº”å¹³å°å’Œæ¶æ„çš„åº”ç”¨ç¨‹åºåŒ…
            2. **Windows**: ç›´æ¥è¿è¡Œ `.exe` æ–‡ä»¶
            3. **Linux**: è§£å‹ `tar.gz` æˆ– `tar.xz` æ–‡ä»¶å¹¶è¿è¡Œå…¶ä¸­çš„åº”ç”¨ç¨‹åº
            4. **macOS**: è§£å‹ `.app.zip` å¹¶å°†åº”ç”¨æ‹–åˆ° Applications æ–‡ä»¶å¤¹
            5. è®¿é—® Web ç•Œé¢ï¼š`http://localhost:8080`
            6. æ‹–æ”¾ DOCX æ–‡ä»¶å¼€å§‹å¯¼å…¥é¢˜ç›®
            
            ### ğŸ“‹ åŠŸèƒ½ç‰¹æ€§
            - âœ… DOCX æ–‡æ¡£è§£æ
            - âœ… å¤šæ¶æ„æ”¯æŒï¼ˆx86_64, ARM, 386ç­‰ï¼‰
            - âœ… è·¨å¹³å°GUIåº”ç”¨
            - âœ… Webç•Œé¢ç®¡ç†
            - âœ… é¢˜ç›®æœç´¢å’Œç®¡ç†
            - âœ… Web API æ¥å£
            - âœ… å›¾å½¢ç•Œé¢ (GUI)
            - âœ… å¤šå¹³å°æ”¯æŒ
            - âœ… åŸç”Ÿåº”ç”¨å›¾æ ‡
            
            ### ğŸ“ ä½¿ç”¨è¯´æ˜
            è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·å‚è€ƒ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
            
            ### ğŸ› é—®é¢˜åé¦ˆ
            å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/${{ github.repository }}/issues) é¡µé¢æäº¤åé¦ˆã€‚
          draft: false
          prerelease: false
          files: |
            ${{ matrix.binary_name }}*.*

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install dependencies
        run: |
          go mod download
          go mod tidy

      - name: Run tests
        run: |
          # Copy test files to main directory to run tests
          cp test/verify_fix.go verify_fix_temp.go
          go run verify_fix_temp.go parser.go models.go
          rm verify_fix_temp.go
          
          cp test/test_parser.go test_parser_temp.go
          go run test_parser_temp.go parser.go models.go
          rm test_parser_temp.go