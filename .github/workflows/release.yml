name: Build and Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  prepare:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    outputs:
      next_release_tag: ${{ steps.generate_release_tag.outputs.next_release_tag }}
    steps:
      - name: Generate release tag
        id: generate_release_tag
        uses: amitsingh-007/next-release-tag@v6.0.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          tag_prefix: "v"
          tag_template: "yyyy.mm.dd.i"

  build-and-release:
    needs: prepare
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: "ubuntu-latest"
            goos: "linux"
            goarch: "amd64"
            binary_name: "tikulocal-linux-amd64"
            package_ext: "tar.gz"
          - platform: "ubuntu-latest"
            goos: "linux"
            goarch: "arm64"
            binary_name: "tikulocal-linux-arm64"
            package_ext: "tar.gz"
          - platform: "windows-latest"
            goos: "windows"
            goarch: "amd64"
            binary_name: "tikulocal-windows-amd64"
            package_ext: "exe"
          - platform: "macos-latest"
            goos: "darwin"
            goarch: "amd64"
            binary_name: "tikulocal-darwin-amd64"
            package_ext: "app"
          - platform: "macos-latest"
            goos: "darwin"
            goarch: "arm64"
            binary_name: "tikulocal-darwin-arm64"
            package_ext: "app"

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install system dependencies (Linux)
        if: matrix.goos == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y golang gcc libgl1-mesa-dev xorg-dev libxkbcommon-dev

      - name: Install system dependencies (Windows)
        if: matrix.goos == 'windows'
        run: |
          # Install MinGW-w64 for Windows builds
          choco install mingw -y
          # Add MinGW to PATH
          echo "C:\ProgramData\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Install system dependencies (macOS)
        if: matrix.goos == 'darwin'
        run: |
          # Install Xcode command line tools if not present
          xcode-select --install || true
          # Ensure pkg-config is available
          brew install pkg-config || true

      - name: Install Fyne tools
        run: |
          go install fyne.io/tools/cmd/fyne@latest

      - name: Install dependencies
        run: |
          go mod download
          go mod tidy

      - name: Build with Fyne (Windows)
        if: matrix.goos == 'windows'
        shell: cmd
        run: |
          fyne package -os windows -icon icon.png
          # Rename the generated exe to match our naming convention
          if exist "tikulocal.exe" (
            move "tikulocal.exe" "${{ matrix.binary_name }}.exe"
          )

      - name: Build with Fyne (Linux)
        if: matrix.goos == 'linux'
        run: |
          fyne package -os linux -icon icon.png
          # Create tar.gz package for Linux
          if [ -d "tikulocal" ]; then
            tar -czf "${{ matrix.binary_name }}.tar.gz" tikulocal/
          elif [ -f "tikulocal" ]; then
            # If it's just a binary, package it
            tar -czf "${{ matrix.binary_name }}.tar.gz" tikulocal
          fi

      - name: Build with Fyne (macOS)
        if: matrix.goos == 'darwin'
        run: |
          fyne package -os darwin -icon icon.png
          # Create zip package for macOS app
          if [ -d "tikulocal.app" ]; then
            zip -r "${{ matrix.binary_name }}.app.zip" tikulocal.app/
          elif [ -f "tikulocal" ]; then
            # If it's just a binary, package it
            zip "${{ matrix.binary_name }}.zip" tikulocal
          fi

      - name: Create Release and Upload Binary
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.prepare.outputs.next_release_tag }}
          name: Release ${{ needs.prepare.outputs.next_release_tag }}
          body: |
            ## ğŸ‰ TikuLocal ${{ needs.prepare.outputs.next_release_tag }}
            
            é¢˜åº“ç®¡ç†ç³»ç»Ÿçš„æœ€æ–°ç‰ˆæœ¬å‘å¸ƒï¼
            
            ### ğŸ“¦ ä¸‹è½½è¯´æ˜
            è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„ç‰ˆæœ¬ä¸‹è½½ï¼š
            
            - **Windows**: `${{ matrix.binary_name }}.exe` (å¸¦å›¾æ ‡çš„å¯æ‰§è¡Œæ–‡ä»¶)
            - **Linux**: `${{ matrix.binary_name }}.tar.gz` (åŒ…å«å›¾æ ‡çš„åº”ç”¨ç¨‹åºåŒ…)
            - **macOS**: `${{ matrix.binary_name }}.app.zip` (å¸¦å›¾æ ‡çš„åº”ç”¨åŒ…)
            
            ### ğŸš€ å¿«é€Ÿå¼€å§‹
            1. ä¸‹è½½å¯¹åº”å¹³å°çš„åº”ç”¨ç¨‹åºåŒ…
            2. **Windows**: ç›´æ¥è¿è¡Œ `.exe` æ–‡ä»¶
            3. **Linux**: è§£å‹ `tar.gz` æ–‡ä»¶å¹¶è¿è¡Œå…¶ä¸­çš„åº”ç”¨ç¨‹åº
            4. **macOS**: è§£å‹ `.app.zip` å¹¶å°†åº”ç”¨æ‹–åˆ° Applications æ–‡ä»¶å¤¹
            5. è®¿é—® Web ç•Œé¢ï¼š`http://localhost:8080`
            6. æ‹–æ”¾ DOCX æ–‡ä»¶å¼€å§‹å¯¼å…¥é¢˜ç›®
            
            ### ğŸ“‹ åŠŸèƒ½ç‰¹æ€§
            - âœ… DOCX æ–‡æ¡£è§£æ
            - âœ… é¢˜ç›®æœç´¢å’Œç®¡ç†
            - âœ… Web API æ¥å£
            - âœ… å›¾å½¢ç•Œé¢ (GUI)
            - âœ… å¤šå¹³å°æ”¯æŒ
            - âœ… åŸç”Ÿåº”ç”¨å›¾æ ‡
            
            ### ğŸ“ ä½¿ç”¨è¯´æ˜
            è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·å‚è€ƒ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
            
            ### ğŸ› é—®é¢˜åé¦ˆ
            å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/${{ github.repository }}/issues) é¡µé¢æäº¤åé¦ˆã€‚
          draft: false
          prerelease: false
          files: |
            ${{ matrix.binary_name }}.*

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install system dependencies (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y golang gcc libgl1-mesa-dev xorg-dev libxkbcommon-dev

      - name: Install Fyne tools
        run: |
          go install fyne.io/tools/cmd/fyne@latest

      - name: Install dependencies
        run: |
          go mod download
          go mod tidy

      - name: Run tests
        run: |
          # Run unit tests
          go test -v ./...
          
          # Run integration tests if they exist
          if [ -f "test/run_tests.bat" ]; then
            echo "Running integration tests..."
            cd test
            # Convert Windows batch to shell script for Linux
            go run verify_fix.go ../parser.go ../models.go
            go run test_parser.go ../parser.go ../models.go
          fi

      - name: Build test
        run: |
          # Test that the project builds successfully
          go build -v .
          
          # Test cross-compilation
          GOOS=windows GOARCH=amd64 go build -v .
          GOOS=darwin GOARCH=amd64 go build -v .
          GOOS=linux GOARCH=amd64 go build -v .

      - name: Test Fyne package
        run: |
          # Test Fyne packaging (without actually creating packages)
          fyne version