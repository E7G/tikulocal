name: æ„å»ºé¢˜åº“ç®¡ç†ç³»ç»Ÿ

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v1.2.6)'
        required: true
        default: 'v1.2.6'
      build_type:
        description: 'æ„å»ºç±»å‹'
        required: true
        default: 'release'
        type: choice
        options:
        - release
        - debug
      platforms:
        description: 'ç›®æ ‡å¹³å°'
        required: true
        default: 'windows'
        type: choice
        options:
        - windows
        - all
        - windows,linux,macos

env:
  GO_VERSION: '1.21'
  FYNE_VERSION: 'latest'

jobs:
  build:
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: ${{ fromJSON(format('[{0}]', github.event.inputs.platforms == 'all' && '["windows-latest", "ubuntu-latest", "macos-latest"]' || github.event.inputs.platforms == 'windows' && '["windows-latest"]' || format('["{0}"]', github.event.inputs.platforms))) }}
        goos: ${{ fromJSON(format('[{0}]', github.event.inputs.platforms == 'all' && '["windows", "linux", "darwin"]' || github.event.inputs.platforms == 'windows' && '["windows"]' || format('["{0}"]', github.event.inputs.platforms))) }}
        goarch: [amd64]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Goç¯å¢ƒ
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: å®‰è£…fyneå·¥å…·
      run: |
        go install fyne.io/tools/cmd/fyne@${{ env.FYNE_VERSION }}
        
    - name: ä¸‹è½½ä¾èµ–
      run: go mod download
      
    - name: éªŒè¯ä¾èµ–
      run: go mod verify
      
    - name: è¿è¡Œæµ‹è¯•
      run: go test -v main_test.go main.go
      
    - name: æ„å»ºåº”ç”¨
      shell: bash
      run: |
        # è®¾ç½®äº¤å‰ç¼–è¯‘ç¯å¢ƒå˜é‡
        export GOOS=${{ matrix.goos }}
        export GOARCH=${{ matrix.goarch }}
        
        echo "ğŸ”¨ å¼€å§‹æ„å»ºåº”ç”¨..."
        echo "ğŸ“‹ æ„å»ºå‚æ•°: GOOS=$GOOS, GOARCH=$GOARCH"
        
        # æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶
        if [ "${{ matrix.goos }}" = "windows" ]; then
          go build -ldflags="-s -w" -o tikulocal.exe .
        else
          go build -ldflags="-s -w" -o tikulocal .
        fi
        
        echo "ğŸ“ æ„å»ºåçš„æ–‡ä»¶åˆ—è¡¨:"
        ls -la
        
    - name: ä½¿ç”¨fyneæ‰“åŒ…
      shell: bash
      run: |
        # è®¾ç½®äº¤å‰ç¼–è¯‘ç¯å¢ƒå˜é‡
        export GOOS=${{ matrix.goos }}
        export GOARCH=${{ matrix.goarch }}
        
        echo "ğŸ“¦ å¼€å§‹ä½¿ç”¨fyneæ‰“åŒ…..."
        echo "ğŸ“‹ æ‰“åŒ…å‚æ•°: GOOS=$GOOS, GOARCH=$GOARCH"
        
        # ä½¿ç”¨fyneæ‰“åŒ…
        if [ "${{ matrix.goos }}" = "windows" ]; then
          fyne package -os windows -icon icon.png -name "é¢˜åº“ç®¡ç†ç³»ç»Ÿ" -appID "com.tikulocal.app"
        elif [ "${{ matrix.goos }}" = "linux" ]; then
          fyne package -os linux -icon icon.png -name "é¢˜åº“ç®¡ç†ç³»ç»Ÿ" -appID "com.tikulocal.app"
        elif [ "${{ matrix.goos }}" = "darwin" ]; then
          fyne package -os darwin -icon icon.png -name "é¢˜åº“ç®¡ç†ç³»ç»Ÿ" -appID "com.tikulocal.app"
        fi
        
        echo "ğŸ“ fyneæ‰“åŒ…åçš„æ–‡ä»¶åˆ—è¡¨:"
        ls -la
        
    - name: é‡å‘½åæ„å»ºäº§ç‰©
      shell: bash
      run: |
        echo "ğŸ“ å½“å‰ç›®å½•æ–‡ä»¶åˆ—è¡¨:"
        ls -la
        
        echo "ğŸ”„ å¼€å§‹é‡å‘½åæ„å»ºäº§ç‰©..."
        
        # é‡å‘½åæ–‡ä»¶ä»¥ä¾¿è¯†åˆ«
        if [ "${{ matrix.goos }}" = "windows" ]; then
          # æ£€æŸ¥å¹¶é‡å‘½åfyneæ‰“åŒ…çš„æ–‡ä»¶
          if [ -f "é¢˜åº“ç®¡ç†ç³»ç»Ÿ.exe" ]; then
            mv "é¢˜åº“ç®¡ç†ç³»ç»Ÿ.exe" "é¢˜åº“ç®¡ç†ç³»ç»Ÿ-${{ github.event.inputs.version }}-${{ matrix.goos }}.exe"
            echo "âœ… é‡å‘½åé¢˜åº“ç®¡ç†ç³»ç»Ÿ.exeæˆåŠŸ"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°é¢˜åº“ç®¡ç†ç³»ç»Ÿ.exe"
          fi
          
          # æ£€æŸ¥å¹¶é‡å‘½ååŸå§‹æ„å»ºæ–‡ä»¶
          if [ -f "tikulocal.exe" ]; then
            mv tikulocal.exe "tikulocal-${{ github.event.inputs.version }}-${{ matrix.goos }}.exe"
            echo "âœ… é‡å‘½åtikulocal.exeæˆåŠŸ"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°tikulocal.exe"
          fi
          
        elif [ "${{ matrix.goos }}" = "linux" ]; then
          # æ£€æŸ¥å¹¶é‡å‘½åfyneæ‰“åŒ…çš„æ–‡ä»¶
          if [ -f "é¢˜åº“ç®¡ç†ç³»ç»Ÿ.tar.gz" ]; then
            mv "é¢˜åº“ç®¡ç†ç³»ç»Ÿ.tar.gz" "é¢˜åº“ç®¡ç†ç³»ç»Ÿ-${{ github.event.inputs.version }}-${{ matrix.goos }}.tar.gz"
            echo "âœ… é‡å‘½åé¢˜åº“ç®¡ç†ç³»ç»Ÿ.tar.gzæˆåŠŸ"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°é¢˜åº“ç®¡ç†ç³»ç»Ÿ.tar.gz"
          fi
          
          # æ£€æŸ¥å¹¶é‡å‘½ååŸå§‹æ„å»ºæ–‡ä»¶
          if [ -f "tikulocal" ]; then
            mv tikulocal "tikulocal-${{ github.event.inputs.version }}-${{ matrix.goos }}"
            echo "âœ… é‡å‘½åtikulocalæˆåŠŸ"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°tikulocal"
          fi
          
        elif [ "${{ matrix.goos }}" = "darwin" ]; then
          # æ£€æŸ¥å¹¶é‡å‘½åfyneæ‰“åŒ…çš„æ–‡ä»¶
          if [ -f "é¢˜åº“ç®¡ç†ç³»ç»Ÿ.app" ]; then
            mv "é¢˜åº“ç®¡ç†ç³»ç»Ÿ.app" "é¢˜åº“ç®¡ç†ç³»ç»Ÿ-${{ github.event.inputs.version }}-${{ matrix.goos }}.app"
            echo "âœ… é‡å‘½åé¢˜åº“ç®¡ç†ç³»ç»Ÿ.appæˆåŠŸ"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°é¢˜åº“ç®¡ç†ç³»ç»Ÿ.app"
          fi
          
          # æ£€æŸ¥å¹¶é‡å‘½ååŸå§‹æ„å»ºæ–‡ä»¶
          if [ -f "tikulocal" ]; then
            mv tikulocal "tikulocal-${{ github.event.inputs.version }}-${{ matrix.goos }}"
            echo "âœ… é‡å‘½åtikulocalæˆåŠŸ"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°tikulocal"
          fi
        fi
        
        echo "ğŸ“ é‡å‘½ååçš„æ–‡ä»¶åˆ—è¡¨:"
        ls -la
        
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: tikulocal-${{ matrix.goos }}-${{ matrix.goarch }}-${{ github.event.inputs.version }}
        path: |
          *.exe
          *.app
          *.tar.gz
          tikulocal-*
        retention-days: 30
        
    - name: æ˜¾ç¤ºæ„å»ºä¿¡æ¯
      shell: bash
      run: |
        echo "æ„å»ºå®Œæˆ!"
        echo "ç‰ˆæœ¬: ${{ github.event.inputs.version }}"
        echo "å¹³å°: ${{ matrix.goos }}-${{ matrix.goarch }}"
        echo "æ„å»ºç±»å‹: ${{ github.event.inputs.build_type }}"
        ls -la *.exe *.app *.tar.gz tikulocal-* 2>/dev/null || echo "æœªæ‰¾åˆ°æ„å»ºäº§ç‰©"

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event.inputs.build_type == 'release'
    
    steps:
    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      
    - name: åˆ›å»ºå‘å¸ƒ
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.version }}
        name: é¢˜åº“ç®¡ç†ç³»ç»Ÿ ${{ github.event.inputs.version }}
        body: |
          ## ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒ
          
          **ç‰ˆæœ¬**: ${{ github.event.inputs.version }}
          **æ„å»ºæ—¶é—´**: ${{ github.event.inputs.build_type }}
          
          ### ğŸ“¦ ä¸‹è½½
          
          è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„å®‰è£…åŒ…ï¼š
          
          - **Windows**: ä¸‹è½½ `.exe` æ–‡ä»¶
          - **Linux**: ä¸‹è½½ `.tar.gz` æ–‡ä»¶
          - **macOS**: ä¸‹è½½ `.app` æ–‡ä»¶
          
          ### ğŸš€ æ›´æ–°å†…å®¹
          
          è¯·æŸ¥çœ‹ [CHANGELOG.md](CHANGELOG.md) äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚
          
          ### ğŸ“‹ ä½¿ç”¨è¯´æ˜
          
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„å®‰è£…åŒ…
          2. è§£å‹æˆ–å®‰è£…ç¨‹åº
          3. è¿è¡Œç¨‹åºå¼€å§‹ä½¿ç”¨
          
          ### ğŸ› é—®é¢˜åé¦ˆ
          
          å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æäº¤ [Issue](https://github.com/${{ github.repository }}/issues)
        draft: false
        prerelease: false
        files: |
          tikulocal-*/*
          *.exe
          *.app
          *.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 