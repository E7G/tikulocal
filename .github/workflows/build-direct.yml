name: æž„å»ºé¢˜åº“ç®¡ç†ç³»ç»Ÿ (ç›´æŽ¥å‘å¸ƒ)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v1.2.6)'
        required: true
        default: 'v1.2.6'
      platform:
        description: 'ç›®æ ‡å¹³å°'
        required: true
        default: 'windows'
        type: choice
        options:
        - windows
        - linux
        - macos

env:
  GO_VERSION: '1.21'
  FYNE_VERSION: 'latest'

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®GoçŽ¯å¢ƒ
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: å®‰è£…fyneå·¥å…·
      run: go install fyne.io/tools/cmd/fyne@${{ env.FYNE_VERSION }}
        
    - name: ä¸‹è½½ä¾èµ–
      run: go mod download
      
    # - name: è¿è¡Œæµ‹è¯•
    #   run: go test -v main_test.go main.go
      
    - name: æž„å»ºåº”ç”¨
      shell: bash
      run: |
        # è®¾ç½®ç›®æ ‡å¹³å°
        export GOOS=${{ github.event.inputs.platform }}
        export GOARCH=amd64
        
        echo "ðŸ”¨ å¼€å§‹æž„å»ºåº”ç”¨..."
        echo "ðŸ“‹ æž„å»ºå‚æ•°: GOOS=$GOOS, GOARCH=$GOARCH"
        echo "æž„å»ºå¹³å°: $GOOS-$GOARCH"
        
        # æž„å»ºå¯æ‰§è¡Œæ–‡ä»¶
        go build -ldflags="-s -w" -o tikulocal .
        
        echo "ðŸ“ æž„å»ºåŽçš„æ–‡ä»¶åˆ—è¡¨:"
        ls -la
        
        # ä½¿ç”¨fyneæ‰“åŒ…
        if [ "$GOOS" = "windows" ]; then
          fyne package -os windows -icon icon.png -name "é¢˜åº“ç®¡ç†ç³»ç»Ÿ"
        elif [ "$GOOS" = "linux" ]; then
          fyne package -os linux -icon icon.png -name "é¢˜åº“ç®¡ç†ç³»ç»Ÿ"
        elif [ "$GOOS" = "macos" ]; then
          fyne package -os darwin -icon icon.png -name "é¢˜åº“ç®¡ç†ç³»ç»Ÿ"
        fi
        
        echo "ðŸ“ fyneæ‰“åŒ…åŽçš„æ–‡ä»¶åˆ—è¡¨:"
        ls -la
        
    - name: é‡å‘½åæž„å»ºäº§ç‰©
      shell: bash
      run: |
        echo "ðŸ“ å½“å‰ç›®å½•æ–‡ä»¶åˆ—è¡¨:"
        ls -la
        
        echo "ðŸ”„ å¼€å§‹é‡å‘½åæž„å»ºäº§ç‰©..."
        
        # é‡å‘½åæ–‡ä»¶ä»¥ä¾¿è¯†åˆ«
        if [ "${{ github.event.inputs.platform }}" = "windows" ]; then
          # æ£€æŸ¥å¹¶é‡å‘½åfyneæ‰“åŒ…çš„æ–‡ä»¶
          if [ -f "é¢˜åº“ç®¡ç†ç³»ç»Ÿ.exe" ]; then
            mv "é¢˜åº“ç®¡ç†ç³»ç»Ÿ.exe" "é¢˜åº“ç®¡ç†ç³»ç»Ÿ-${{ github.event.inputs.version }}-${{ github.event.inputs.platform }}.exe"
            echo "âœ… é‡å‘½åé¢˜åº“ç®¡ç†ç³»ç»Ÿ.exeæˆåŠŸ"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°é¢˜åº“ç®¡ç†ç³»ç»Ÿ.exe"
          fi
          
          # æ£€æŸ¥å¹¶é‡å‘½ååŽŸå§‹æž„å»ºæ–‡ä»¶
          if [ -f "tikulocal.exe" ]; then
            mv tikulocal.exe "tikulocal-${{ github.event.inputs.version }}-${{ github.event.inputs.platform }}.exe"
            echo "âœ… é‡å‘½åtikulocal.exeæˆåŠŸ"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°tikulocal.exe"
          fi
          
        elif [ "${{ github.event.inputs.platform }}" = "linux" ]; then
          # æ£€æŸ¥å¹¶é‡å‘½åfyneæ‰“åŒ…çš„æ–‡ä»¶
          if [ -f "é¢˜åº“ç®¡ç†ç³»ç»Ÿ.tar.gz" ]; then
            mv "é¢˜åº“ç®¡ç†ç³»ç»Ÿ.tar.gz" "é¢˜åº“ç®¡ç†ç³»ç»Ÿ-${{ github.event.inputs.version }}-${{ github.event.inputs.platform }}.tar.gz"
            echo "âœ… é‡å‘½åé¢˜åº“ç®¡ç†ç³»ç»Ÿ.tar.gzæˆåŠŸ"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°é¢˜åº“ç®¡ç†ç³»ç»Ÿ.tar.gz"
          fi
          
          # æ£€æŸ¥å¹¶é‡å‘½ååŽŸå§‹æž„å»ºæ–‡ä»¶
          if [ -f "tikulocal" ]; then
            mv tikulocal "tikulocal-${{ github.event.inputs.version }}-${{ github.event.inputs.platform }}"
            echo "âœ… é‡å‘½åtikulocalæˆåŠŸ"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°tikulocal"
          fi
          
        elif [ "${{ github.event.inputs.platform }}" = "macos" ]; then
          # æ£€æŸ¥å¹¶é‡å‘½åfyneæ‰“åŒ…çš„æ–‡ä»¶
          if [ -f "é¢˜åº“ç®¡ç†ç³»ç»Ÿ.app" ]; then
            mv "é¢˜åº“ç®¡ç†ç³»ç»Ÿ.app" "é¢˜åº“ç®¡ç†ç³»ç»Ÿ-${{ github.event.inputs.version }}-${{ github.event.inputs.platform }}.app"
            echo "âœ… é‡å‘½åé¢˜åº“ç®¡ç†ç³»ç»Ÿ.appæˆåŠŸ"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°é¢˜åº“ç®¡ç†ç³»ç»Ÿ.app"
          fi
          
          # æ£€æŸ¥å¹¶é‡å‘½ååŽŸå§‹æž„å»ºæ–‡ä»¶
          if [ -f "tikulocal" ]; then
            mv tikulocal "tikulocal-${{ github.event.inputs.version }}-${{ github.event.inputs.platform }}"
            echo "âœ… é‡å‘½åtikulocalæˆåŠŸ"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°tikulocal"
          fi
        fi
        
        echo "ðŸ“ é‡å‘½ååŽçš„æ–‡ä»¶åˆ—è¡¨:"
        ls -la
        
    - name: Create tag
      uses: rickstaa/action-create-tag@v1
      with:
      tag: ${{ github.event.inputs.version }}

    - name: åˆ›å»ºRelease
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.version }}
        name: é¢˜åº“ç®¡ç†ç³»ç»Ÿ ${{ github.event.inputs.version }}
        body: |
          ## ðŸŽ‰ æ–°ç‰ˆæœ¬å‘å¸ƒ
          
          **ç‰ˆæœ¬**: ${{ github.event.inputs.version }}
          **å¹³å°**: ${{ github.event.inputs.platform }}
          **æž„å»ºæ—¶é—´**: ${{ github.run_number }}
          
          ### ðŸ“¦ ä¸‹è½½
          
          è¯·ä¸‹è½½å¯¹åº”å¹³å°çš„å®‰è£…åŒ…ï¼š
          
          ${{ github.event.inputs.platform == 'windows' && '- **Windows**: ä¸‹è½½ `.exe` æ–‡ä»¶' || '' }}
          ${{ github.event.inputs.platform == 'linux' && '- **Linux**: ä¸‹è½½ `.tar.gz` æ–‡ä»¶' || '' }}
          ${{ github.event.inputs.platform == 'macos' && '- **macOS**: ä¸‹è½½ `.app` æ–‡ä»¶' || '' }}
          
          ### ðŸš€ æ›´æ–°å†…å®¹
          
          è¯·æŸ¥çœ‹ [CHANGELOG.md](CHANGELOG.md) äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚
          
          ### ðŸ“‹ ä½¿ç”¨è¯´æ˜Ž
          
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„å®‰è£…åŒ…
          2. è§£åŽ‹æˆ–å®‰è£…ç¨‹åº
          3. è¿è¡Œç¨‹åºå¼€å§‹ä½¿ç”¨
          
          ### ðŸ› é—®é¢˜åé¦ˆ
          
          å¦‚æžœé‡åˆ°é—®é¢˜ï¼Œè¯·æäº¤ [Issue](https://github.com/${{ github.repository }}/issues)
        draft: false
        prerelease: false
        files: |
          *.exe
          *.app
          *.tar.gz
          tikulocal-*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: æ˜¾ç¤ºæž„å»ºä¿¡æ¯
      shell: bash
      run: |
        echo "âœ… æž„å»ºå’Œå‘å¸ƒå®Œæˆ!"
        echo "ðŸ“¦ ç‰ˆæœ¬: ${{ github.event.inputs.version }}"
        echo "ðŸ–¥ï¸ å¹³å°: ${{ github.event.inputs.platform }}"
        echo "ðŸ“ æž„å»ºäº§ç‰©:"
        ls -la *.exe *.app *.tar.gz tikulocal-* 2>/dev/null || echo "æœªæ‰¾åˆ°æž„å»ºäº§ç‰©" 